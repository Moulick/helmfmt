Парсинг кода:

1. Критерий открытия комментария: наличие `{{\*` в строке
2. Критерий закрытия комментария: наличие `*/}}` в той же или в одной из последующих строк.

3. Критерий открытия обьявления переменной. Строка может начинаться с:

- `{{`(0 or more spaces) `$var`
- `{{-`(1 or more spaces) `$var`

4. Критерий закрытия объявления переменной: `-}}` или `}}` в той же строке.

5. Критерий открытия include/fail/toYaml/printf. Строка может начинаться с:

- `{{`(0 or more spaces) `include/fail/toYaml/printf`
- `{{-`(1 or more spaces) `include/fail/toYaml/printf`

6. Критерий закрытия include: `-}}` или `}}` в той же строке.

7. Критерий открытия начала управляющей конструкции. Строка может начинаться с:

- `{{`(0 or more spaces) control
- `{{-`(1 or more spaces) control

8. Критерий закрытия начала управляющей конструкции: `-}}` или `}}` в той же или в одной из последующих строк. Причём если встречается открытие комментария, то нужно найти его закрытие в этой или в последующей строке и только потом продолжать поиск закрытия управляющей конструкции.

9. Критерий открытия конца управляющей конструкции. Строка может начинаться на:

- `{{`(0 or more spaces) end
- `{{-`(1 or more spaces) end

10. Критерий закрытия конца управляющей конструкции: `-}}` или `}}` в той же строке.

Сценарии:

- линия начинается с открытия начала управляющей конструкции.
- линия начинается с комментария, а открытие начала управляющей конструкции начинается после закрытия комментария в этой же или следующей строке.
- линия начинается с закрытия конца управляющей конструкции.
- линия начинается с комментария, а закрытие конца управляющей конструкции начинается после закрытия комментария в этой же или следующей строке.
- линия начинается с открытия объявления переменной.
- линия начинается с комментария, а открытие начала объявления переменной начинается после закрытия комментария в этой же или следующей строке.

Требования:

- у управляющей конструкции должен быть отступ относительно другой управляющей конструкции
- у объявления переменной должен быть отступ относительно управляющей конструкции, внури которой находится объявление переменной
- у инструкций include, printf и т. п., должен быть отступ

Исключения:

- если управляющая конструкция содержит конец в той же строке, где её начало, то у таких строк не должен прибавляться отступ, т. е. он должен быть таким же, как у переменных. Причём нужно иметь в виду, что между началом и концом управляющей конструкции может быть комментарий
